<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Selfie Search v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--muted:#8b92a6;--text:#e7eaf3;--acc:#ff7b57;--ok:#3ecf8e;--warn:#ffcc66;--err:#ff5d5d;--chip:#222738;
    }
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    h1{font-size:28px;margin:24px 0 12px}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:24px;grid-template-columns:340px 1fr}
    .card{background:var(--panel);border:1px solid #222532;border-radius:14px;padding:16px}
    label{display:block;color:var(--muted);font-size:12px;margin:12px 0 6px}
    input,select,button{font:inherit}
    .in{width:100%;padding:10px 12px;border-radius:10px;background:#0d0f14;border:1px solid #242835;color:var(--text);outline:none}
    .row{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #2a3040;background:#1c2230;color:#fff;cursor:pointer}
    .btn:hover{background:#20283a}
    .btn.acc{background:var(--acc);border-color:#ff693f;color:#190e0b}
    .btn.ghost{background:transparent;border-color:#2a3040}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #2a3040;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .log{white-space:pre-wrap;background:#0b0d12;border:1px dashed #2a3040;border-radius:12px;padding:12px;max-height:240px;overflow:auto}
    .grid2{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .tile{background:#0d1017;border:1px solid #222532;border-radius:12px;overflow:hidden}
    .tile img{display:block;width:100%;height:180px;object-fit:cover;background:#0a0c11}
    .tile .meta{padding:10px 12px}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
    .sep{height:1px;background:#222532;margin:12px 0}
    small.code{font-family:ui-monospace,Menlo,Consolas,monospace;color:#9aa3b2}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Selfie Search</h1>

    <div class="grid">
      <!-- Left panel -->
      <div class="card">
        <div class="pill" id="statusChip">ready</div>

        <label>API Base (fixed)</label>
        <input id="apiBase" class="in" value="https://87pwi4umfk.execute-api.ap-southeast-1.amazonaws.com" />

        <label>Public Image Base (GET)</label>
        <input id="publicBase" class="in" value="https://selfiesearch-v2-uploads.s3.amazonaws.com" />

        <div class="row">
          <div style="flex:1">
            <label>Threshold</label>
            <input id="threshold" class="in" type="number" value="85" />
          </div>
          <div style="width:120px">
            <label>Max Faces</label>
            <input id="maxFaces" class="in" type="number" value="5" />
          </div>
        </div>

        <label>Limit to folder (prefix)</label>
        <input id="prefix" class="in" placeholder="e.g. common2" value="COMMON2" />

        <label>Choose file</label>
        <input id="file" class="in" type="file" accept="image/*" />

        <div class="row" style="margin-top:12px">
          <button id="btnUploadSearch" class="btn acc">Upload & Search</button>
          <button id="btnClear" class="btn ghost">Clear</button>
        </div>

        <div class="sep"></div>

        <label>Or search an existing key (already in S3)</label>
        <input id="existingKey" class="in" placeholder="COMMON2/your-image.jpg" />
        <div class="row" style="margin-top:10px">
          <button id="btnSearchByKey" class="btn">Search by Key</button>
        </div>

        <div class="sep"></div>

        <label>Logs</label>
        <div id="log" class="log">ready</div>
      </div>

      <!-- Results -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill"><span>Results</span> <span id="resultCount">0</span></div>
          <button id="btnDownloadSel" class="btn ghost">Download Selected</button>
        </div>
        <div class="sep"></div>
        <div id="results" class="grid2"></div>
      </div>
    </div>
  </div>

<script>
/** ====== CONFIG (edit these 3 if needed) ====== **/
const API_BASE_DEFAULT     = "https://87pwi4umfk.execute-api.ap-southeast-1.amazonaws.com";
const PUBLIC_IMG_BASE_DEF  = "https://selfiesearch-v2-uploads.s3.amazonaws.com";
const ALLOWED_ORIGIN       = "https://selfiesearch2.netlify.app";
/** ============================================ **/

const el = id => document.getElementById(id);
const log = (...a)=>{ const s=a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' '); const box=el('log'); box.textContent = (box.textContent? box.textContent+"\n":"")+s; box.scrollTop=box.scrollHeight; };

function setChip(text, cls='') {
  const chip = el('statusChip');
  chip.textContent = text;
  chip.className = 'pill '+cls;
}

function buildKey(prefix, fileName){
  const ts = new Date().toISOString().replace(/[^\dTZ]/g,'').replace('Z','');
  const clean = fileName.replace(/\s+/g,'_');
  let p = (prefix||'').replace(/^\/+|\/+$/g,'');
  return (p? p+'/':'') + ts + '_' + clean;
}

async function postJSON(url, body){
  const r = await fetch(url,{
    method:'POST',
    mode:'cors',
    cache:'no-store',
    credentials:'omit',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  const text = await r.text();
  let data = null;
  try{ data = text ? JSON.parse(text) : {}; }catch(e){ data = {raw:text}; }
  if(!r.ok){ const err = new Error('HTTP '+r.status); err.response=data; throw err; }
  return data;
}

async function putBinary(url, file, contentType){
  // IMPORTANT: only send Content-Type that was used during presign
  return fetch(url, {
    method:'PUT',
    mode:'cors',
    cache:'no-store',
    headers: contentType ? {'Content-Type': contentType} : undefined,
    body:file
  }).then(r=>{
    if(!r.ok) throw new Error('S3 PUT failed '+r.status);
    return true;
  });
}

function renderResults(matches, publicBase){
  const box = el('results');
  box.innerHTML = '';
  el('resultCount').textContent = matches.length;
  if(!matches.length){ return; }
  for(const m of matches){
    const f = m.Face || {};
    const imgKey = f.ExternalImageId || f.externalImageId || f.ImageId || '';
    const url = imgKey ? `${publicBase.replace(/\/+$/,'')}/${imgKey.replace(/^\/+/,'')}` : '';
    const div = document.createElement('div');
    div.className = 'tile';
    div.innerHTML = `
      <img src="${url || ''}" onerror="this.style.display='none'" alt="">
      <div class="meta">
        <div><b>Similarity:</b> ${(m.Similarity ?? m.similarity ?? 0).toFixed(2)}%</div>
        <div class="muted"><small>Confidence:</small> ${(f.Confidence ?? 0).toFixed(2)}%</div>
        <div class="muted"><small>ImageId:</small> <small class="code">${f.ImageId||'-'}</small></div>
        <div class="muted"><small>ExternalImageId:</small> <small class="code">${imgKey||'-'}</small></div>
      </div>`;
    box.appendChild(div);
  }
}

async function doSearchByKey(key){
  const apiBase   = (el('apiBase').value||API_BASE_DEFAULT).replace(/\/+$/,'');
  const threshold = parseFloat(el('threshold').value||'85');
  const maxFaces  = parseInt(el('maxFaces').value||'5',10);
  const publicBase= el('publicBase').value || PUBLIC_IMG_BASE_DEF;

  setChip('searching...');
  log('POST', apiBase+'/search', {key, threshold, maxFaces});
  const res = await postJSON(apiBase+'/search', { key, threshold, maxFaces });
  log('search response:', res);
  try{
    const body = typeof res.body==='string' ? JSON.parse(res.body) : (res.body||res);
    const matches = body.matches || body.FaceMatches || [];
    renderResults(matches, publicBase);
    setChip('done', 'ok');
  }catch(e){
    setChip('parse error','warn');
    log('parse error', e.message);
  }
}

async function handleUploadAndSearch(){
  try{
    const file = el('file').files[0];
    if(!file){ alert('Choose a file first'); return; }

    const apiBase   = (el('apiBase').value||API_BASE_DEFAULT).replace(/\/+$/,'');
    const publicBase= el('publicBase').value || PUBLIC_IMG_BASE_DEF;
    const threshold = parseFloat(el('threshold').value||'85');
    const maxFaces  = parseInt(el('maxFaces').value||'5',10);
    const prefix    = el('prefix').value||'';
    const key       = buildKey(prefix, file.name);
    const contentType = file.type || 'image/jpeg';

    setChip('requesting presign...');
    const req = { key, contentType, event:'manual' };
    log('POST', apiBase+'/upload-url', req);
    const presign = await postJSON(apiBase+'/upload-url', req);
    log('presign response:', presign);

    // Handle possible {body: "..."} shape
    const p = typeof presign.body==='string' ? JSON.parse(presign.body) : (presign.body||presign);
    const uploadUrl = p.uploadUrl || p.url || p.presignedUrl;
    if(!uploadUrl) throw new Error('uploadUrl missing');

    setChip('uploading to S3...');
    await putBinary(uploadUrl, file, contentType);
    setChip('uploaded', 'ok');
    log('PUT', uploadUrl, '[OK]');

    setChip('searching...');
    const searchPayload = { key, threshold, maxFaces };
    log('POST', apiBase+'/search', searchPayload);
    const res = await postJSON(apiBase+'/search', searchPayload);
    log('search response:', res);

    const body = typeof res.body==='string' ? JSON.parse(res.body) : (res.body||res);
    const matches = body.matches || body.FaceMatches || [];
    renderResults(matches, publicBase);
    setChip('done', 'ok');
  }catch(e){
    setChip('error','err');
    log('ERROR:', e.message, e.response||'');
    alert('Error: '+e.message);
  }
}

el('btnUploadSearch').onclick = handleUploadAndSearch;
el('btnClear').onclick = () => {
  el('file').value = '';
  el('existingKey').value = '';
  el('results').innerHTML = '';
  el('resultCount').textContent = '0';
  el('log').textContent = 'ready';
  setChip('ready');
};
el('btnSearchByKey').onclick = () => {
  const k = el('existingKey').value.trim();
  if(!k){ alert('Enter S3 key'); return; }
  doSearchByKey(k);
};
</script>
</body>
</html>

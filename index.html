<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selfie Search</title>
<style>
:root{--bg:#0b1220;--fg:#e9eef7;--muted:#9bb0d3;--card:#131b2e;--accent:#5b9dff;--danger:#ef5a5a;--ok:#1db954;--border:#223154}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,sans-serif}
.container{max-width:980px;margin:auto;padding:16px}
header,.footer{display:flex;justify-content:space-between;align-items:center}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:10px 0 18px}
input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0f1627;color:var(--fg)}
button{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
button.ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
.link{color:var(--muted);text-decoration:none}.link:hover{text-decoration:underline}
.status{margin-top:12px;padding:10px;border-radius:10px;background:#0f1627;border:1px solid var(--border);color:var(--muted)}
.status.success{border-color:var(--ok);color:#c7ffdc}
.status.error{border-color:var(--danger);color:#ffd0d0}
.results{margin-top:16px}.hidden{display:none}
table{width:100%;border-collapse:collapse;background:#0f1627;border:1px solid var(--border);border-radius:10px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px}
thead th{background:#0b1324;text-align:left}
small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:var(--muted)}
</style>
</head>
<body>
<header class="container">
  <h1>Selfie Search</h1>
  <nav>
    <a href="admin.html" class="link">Admin</a>
    <button id="btnTestConfig" class="ghost">Test Config</button>
  </nav>
</header>

<main class="container card">
  <form id="searchForm">
    <div class="grid">
      <label>S3 Key (photo file name)
        <input name="key" required placeholder="selfie.jpg" />
      </label>
      <label>Threshold
        <input type="number" name="threshold" min="1" max="100" value="85" />
      </label>
      <label>Max Faces
        <input type="number" name="maxFaces" min="1" max="50" value="5" />
      </label>
    </div>
    <button type="submit">Search</button>
  </form>

  <section id="status" class="status"></section>

  <section id="results" class="results hidden">
    <h2>Results</h2>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Score</th><th>FaceId</th><th>Photo</th><th>Bucket</th><th>Meta</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
    <p><small class="mono">Tip: CORS में <code>Content-Type</code> और (optional) <code>x-api-key</code> allow करें.</small></p>
  </section>
</main>

<footer class="container footer"><small>© Your Org</small></footer>

<script>
const LS_KEY='selfiesearch_cfg';
const $=s=>document.querySelector(s);
const statusEl=$("#status"), resultsEl=$("#results"), tbodyEl=$("#resultsBody");

const readCfg=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch{return{}}};
const cfgUrl=()=>{const{apiBase,route}=readCfg(); if(!apiBase||!route) throw new Error('Admin में API Base और Route सेट करें.'); return apiBase.replace(/\/$/,'')+route;};
const cfgHeaders=()=>{const h={'Content-Type':'application/json'}; const{apiKey}=readCfg(); if(apiKey)h['x-api-key']=apiKey; return h;};
const show=(msg,kind='info')=>{statusEl.className='status '+kind; statusEl.textContent=msg;};
const render=(rows)=>{tbodyEl.innerHTML=''; rows.forEach((r,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`
<td>${i+1}</td>
<td>${(r.score??0).toFixed(3)}</td>
<td><code>${r.faceId||''}</code></td>
<td>${r.Photo||r.photo||''}</td>
<td>${r.Bucket||r.bucket||''}</td>
<td><code>${JSON.stringify(r.meta||{})}</code></td>`; tbodyEl.appendChild(tr)}); resultsEl.classList.toggle('hidden',!rows.length);};

async function doSearch(payload){
  const res=await fetch(cfgUrl(),{method:'POST',headers:cfgHeaders(),body:JSON.stringify(payload)});
  const txt=await res.text(); if(!res.ok) throw new Error(`${res.status} ${res.statusText} — ${txt}`);
  try{return JSON.parse(txt)}catch{return txt}
}

$("#searchForm").addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const payload={key:fd.get('key'),threshold:Number(fd.get('threshold')||85),maxFaces:Number(fd.get('maxFaces')||5)};
  show('Searching…');
  try{
    const out=await doSearch(payload);
    let rows=[]; if(Array.isArray(out)) rows=out;
    else if(out&&typeof out.body==='string') rows=JSON.parse(out.body);
    else if(out&&typeof out==='object') rows=out.results||out;
    render(rows); show('Done ✅','success');
  }catch(err){show(err.message||String(err),'error'); render([]);}
});

$("#btnTestConfig").addEventListener('click',()=>{try{show(`OK: ${cfgUrl()}`,'success')}catch(e){show(e.message,'error')}});
</script>
</body>
</html>

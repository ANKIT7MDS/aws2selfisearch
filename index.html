<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Selfie Search</title>
<style>
:root{--bg:#0b1220;--panel:#121a2a;--text:#e9edf1;--muted:#9fb0c3;--accent:#5a8bff;--ok:#19c37d;--bad:#ef4444;--border:#1e2a43}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto}
header{padding:18px 16px;text-align:center;font-weight:700;font-size:26px}
.wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
.grid{display:grid;gap:16px}
@media(min-width:920px){.grid{grid-template-columns:420px 1fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,button{border-radius:10px;border:1px solid var(--border);background:#0f1728;color:var(--text);padding:10px 12px}
button{background:var(--accent);border:none;color:#fff;font-weight:600;cursor:pointer}
button.ghost{background:transparent}
button:disabled{opacity:.6;cursor:not-allowed}
.row{display:grid;gap:12px}
.cfg{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:560px){.cfg{grid-template-columns:1fr}}
video,canvas{width:100%;border-radius:12px;background:#000}
.pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#182445;color:#aecdff;font-size:12px;margin-right:6px}
.hint{color:var(--muted);font-size:13px}
.bar{height:8px;background:#0d1423;border-radius:20px;overflow:hidden}
.bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#6ae,#59f);transition:width .25s}
.row-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.results{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.tile{background:#0f1728;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.tile img{width:100%;display:block}
.tile .meta{padding:8px 10px;font-size:12px;color:var(--muted)}
small.err{color:var(--bad)}
</style>
</head>
<body>
<header>Selfie Search</header>

<div class="wrap grid">
  <!-- Left: capture/upload + config -->
  <section class="card">
    <div class="row">
      <div class="cfg">
        <div>
          <label>API Base</label>
          <input id="apiBase" placeholder="https://YOUR.execute-api.ap-southeast-1.amazonaws.com"/>
        </div>
        <div>
          <label>API Key (optional)</label>
          <input id="apiKey" placeholder="x-api-key (अगर enabled हो)"/>
        </div>
      </div>

      <div class="cfg">
        <div>
          <label>Threshold</label>
          <input id="threshold" type="number" min="0" max="100" value="85"/>
        </div>
        <div>
          <label>Max Faces</label>
          <input id="maxFaces" type="number" min="1" max="50" value="5"/>
        </div>
      </div>

      <div>
        <div class="row-inline">
          <button id="saveCfg">Save</button>
          <button class="ghost" id="testCfg">Test Config</button>
          <span class="pill" id="stat">Idle</span>
          <span class="pill" id="took"></span>
        </div>
      </div>

      <div>
        <label>Camera</label>
        <video id="video" autoplay playsinline muted></video>
        <div class="row-inline" style="margin-top:8px">
          <button id="openCam">Open Camera</button>
          <button id="btnCapture" disabled>Capture</button>
          <input id="filePick" type="file" accept="image/*" hidden />
          <button id="btnPick">Choose File</button>
        </div>
        <div class="hint">कैमरा से कैप्चर करें या फ़ोन/लैपटॉप से कोई फोटो चुनें।</div>
      </div>

      <div>
        <label>Search</label>
        <div class="row-inline">
          <input id="prefix" placeholder="Limit to folder (optional, e.g. common2/)"/>
          <button id="btnSearch" disabled>Search</button>
        </div>
        <div class="hint">यह बटन **आख़िरी कैप्चर/अपलोड** की गयी सेल्फ़ी पर search चलाएगा।</div>
      </div>

      <div>
        <label>Progress</label>
        <div class="bar"><i id="pbar"></i></div>
      </div>

      <div id="lastKeyWrap" class="hint" style="display:none">
        Last selfie key: <code id="lastKey"></code>
      </div>
    </div>
  </section>

  <!-- Right: results -->
  <section class="card">
    <div class="row">
      <div id="grid" class="results"></div>
      <pre id="raw" class="hint" style="white-space:pre-wrap"></pre>
    </div>
  </section>
</div>

<script>
const $ = id=>document.getElementById(id);
const cfg = {
  apiBase: localStorage.getItem('apiBase') || '',
  apiKey:  localStorage.getItem('apiKey')  || '',
  threshold: +(localStorage.getItem('threshold') || 85),
  maxFaces: +(localStorage.getItem('maxFaces') || 5),
  prefix: localStorage.getItem('prefix') || ''
};
$('apiBase').value=cfg.apiBase; $('apiKey').value=cfg.apiKey;
$('threshold').value=cfg.threshold; $('maxFaces').value=cfg.maxFaces; $('prefix').value=cfg.prefix;

let stream, lastSelfieKey=null, lastBlob=null;

$('saveCfg').onclick=()=>{
  cfg.apiBase=$('apiBase').value.trim().replace(/\/$/,'');
  cfg.apiKey=$('apiKey').value.trim();
  cfg.threshold=+$('threshold').value; cfg.maxFaces=+$('maxFaces').value; cfg.prefix=$('prefix').value.trim();
  for(const k in cfg) localStorage.setItem(k,cfg[k]);
  msg('Saved'); 
};
$('testCfg').onclick=async()=>{
  try{ await apiPOST('/upload-url',{key:`test/${Date.now()}.jpg`,contentType:'image/jpeg',event:'test'}); msg('Config OK'); }
  catch(e){ msg('Config error: '+e.message,true); }
};

$('openCam').onclick=async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    $('video').srcObject = stream;
    $('btnCapture').disabled=false;
    msg('Camera ready');
  }catch(e){ msg('Camera error: '+e.message,true); }
};

$('btnPick').onclick=()=>$('filePick').click();
$('filePick').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  lastBlob=f; await uploadThenEnableSearch(f);
};

$('btnCapture').onclick=async ()=>{
  try{
    const blob = await takeSnapshot($('video'));
    lastBlob = blob;
    await uploadThenEnableSearch(blob);
  }catch(e){ msg('Capture error: '+e.message,true); }
};

$('btnSearch').onclick=async ()=>{
  if(!lastSelfieKey){ msg('No selfie captured/uploaded',true); return; }
  await runSearch(lastSelfieKey);
};

function msg(t,err=false){ $('stat').textContent=t; $('stat').style.background=err?'#3a1a23':'#182445'; $('stat').style.color=err?'#ffd0d0':'#aecdff'; }
function progress(p){ $('pbar').style.width=p+'%'; }

function takeSnapshot(video){
  const c=document.createElement('canvas');
  const w=video.videoWidth||960,h=video.videoHeight||720;
  c.width=w;c.height=h; c.getContext('2d').drawImage(video,0,0,w,h);
  return new Promise(r=>c.toBlob(r,'image/jpeg',0.92));
}

async function uploadThenEnableSearch(blob){
  guard(true);
  try{
    progress(15); msg('Requesting upload URL…');
    const key=`temp/selfie-${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
    const j = await apiPOST('/upload-url',{key,contentType:'image/jpeg',event:'selfie'});
    if(!j.uploadUrl) throw new Error('no uploadUrl');
    progress(45); msg('Uploading selfie…');
    await fetch(j.uploadUrl,{method:'PUT',headers:{'Content-Type':'image/jpeg'},body:blob});
    progress(70); msg('Ready to search');
    lastSelfieKey=key;
    $('lastKey').textContent=key; $('lastKeyWrap').style.display='';
    $('btnSearch').disabled=false;
    progress(80);
  }catch(e){ msg('Upload failed: '+e.message,true); }
  finally{ guard(false); setTimeout(()=>progress(0),700); }
}

async function runSearch(key){
  guard(true);
  try{
    progress(85); msg('Searching…');
    let path='/search';
    if(cfg.prefix){ const q=new URLSearchParams({prefix:cfg.prefix}); path += `?${q.toString()}`; }
    const out = await apiPOST(path,{key,threshold:cfg.threshold,maxFaces:cfg.maxFaces});
    renderResults(out);
    msg('Done');
    progress(100);
  }catch(e){ msg('Search error: '+e.message,true); }
  finally{ guard(false); setTimeout(()=>progress(0),700); }
}

async function apiPOST(path, data){
  if(!cfg.apiBase) throw new Error('Set API Base');
  const url = cfg.apiBase + path;
  const headers={'Content-Type':'application/json'};
  if(cfg.apiKey) headers['x-api-key']=cfg.apiKey;
  const res = await fetch(url,{method:'POST',headers,body:JSON.stringify(data)});
  const text = await res.text();
  if(!res.ok) throw new Error(`HTTP ${res.status} ${text}`);
  try{ return JSON.parse(text); }catch{ return text; }
}

function renderResults(json){
  const grid=$('grid'); grid.innerHTML='';
  const raw=$('raw');
  raw.textContent = typeof json==='string' ? json : JSON.stringify(json,null,2);

  let rows=[];
  if(Array.isArray(json)) rows=json;
  else if(json && typeof json.body==='string'){ try{ rows=JSON.parse(json.body);}catch{} }
  else if(json && Array.isArray(json.results)) rows=json.results;

  if(!rows || !rows.length){ grid.innerHTML='<small class="hint">No matches</small>'; return; }

  for(const r of rows){
    const li=document.createElement('div'); li.className='tile';
    li.innerHTML=`
      <img alt="" loading="lazy" src="" />
      <div class="meta">
        <div><b>${((r.score||r.Similarity)||0).toFixed(2)}%</b> • ${r.Photo||r.key||''}</div>
        <div class="hint">${r.Bucket||''}</div>
      </div>
    `;
    grid.appendChild(li);
  }
}

function guard(lock){
  $('btnCapture').disabled=lock;
  $('btnPick').disabled=lock;
  $('btnSearch').disabled=lock || !lastSelfieKey;
}

</script>
</body>
</html>

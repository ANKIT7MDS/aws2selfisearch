<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Selfie Search</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--muted:#9aa4b2;--text:#e8edf3;--brand:#ff7a59;
      --ok:#21c995;--warn:#f5a623;--bad:#ff5c5c;--chip:#222734;
      --border:1px solid #232836;
    }
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px}
    .card{background:var(--panel);border-radius:14px;border:var(--border);padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{margin:6px 0}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button{border-radius:10px;border:var(--border);background:#0e1118;color:var(--text);padding:10px 12px;font-size:14px;outline:none}
    input:disabled{opacity:.6}
    button{cursor:pointer;background:#141925;border-color:#2a3143}
    button.primary{background:var(--brand);color:#16181e;border:none}
    button.ghost{background:#0e1118}
    button:disabled{opacity:.5;cursor:not-allowed}
    .kpi{display:flex;gap:12px;align-items:center}
    .pill{padding:4px 10px;border-radius:999px;background:var(--chip);font-size:12px;color:#c8d0dc;border:var(--border)}
    .danger{color:var(--bad)} .success{color:var(--ok)} .warn{color:var(--warn)}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .tile{background:#0d1118;border:var(--border);border-radius:12px;overflow:hidden}
    .tile img{width:100%;height:160px;object-fit:cover;display:block;background:#0b0e13}
    .meta{padding:8px 10px;font-size:12px;color:#c2c9d6;display:flex;justify-content:space-between;gap:8px}
    .muted{color:var(--muted)}
    .log{min-height:48px;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0e13;border-radius:10px;border:var(--border);padding:10px;white-space:pre-wrap}
    .split{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px 0;">Selfie Search</h1>
    <div class="grid">
      <!-- left -->
      <section class="card">
        <div class="row">
          <div style="flex:1 1 100%;">
            <label>API Base (fixed)</label>
            <input id="apiBase" value="https://87pwi4umfk.execute-api.ap-southeast-1.amazonaws.com" disabled>
            <div class="hint">POST /upload-url, POST /search</div>
          </div>
          <div style="flex:1 1 100%;">
            <label>Public Image Base (GET)</label>
            <input id="publicBase" value="https://selfiesearch-v2-uploads.s3.amazonaws.com">
            <div class="hint">S3 static URL prefix</div>
          </div>
        </div>

        <hr style="border:none;border-top:var(--border);margin:10px 0 14px">

        <div class="row">
          <div style="flex:1 1 110px">
            <label>Threshold</label>
            <input id="threshold" type="number" value="85" min="0" max="100">
          </div>
          <div style="flex:1 1 120px">
            <label>Max Faces</label>
            <input id="maxFaces" type="number" value="5" min="1" max="50">
          </div>
          <div style="flex:1 1 100%">
            <label>Limit to folder (optional prefix)</label>
            <input id="prefix" placeholder="e.g. common2/">
          </div>
        </div>

        <div class="row" style="margin-top:6px;">
          <div class="split" style="flex:1 1 100%;">
            <div>
              <label>Choose file</label>
              <input id="file" type="file" accept="image/*">
            </div>
            <button id="btnUpload" class="primary">Upload & Search</button>
          </div>
          <div class="hint" style="margin-top:-4px;">Upload S3 पर होगा, फिर उसी key पर /search चलती है</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="split" style="flex:1 1 100%;">
            <div>
              <label>Or search an existing key (already in S3)</label>
              <input id="manualKey" placeholder="e.g. common2/cli-test.jpg">
            </div>
            <button id="btnSearch" class="ghost">Search by Key</button>
          </div>
        </div>

        <div style="margin-top:14px;">
          <div class="kpi">
            <span class="pill" id="kpiStatus">idle</span>
            <span class="pill" id="kpiCount">0 matches</span>
          </div>
          <div id="log" class="log" style="margin-top:8px;"></div>
        </div>
      </section>

      <!-- right -->
      <section class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button id="btnClear" class="ghost">Clear</button>
          </div>
          <div class="pill" id="pageInfo">Page 1/1</div>
        </div>

        <div id="results" class="thumbs" style="margin-top:12px;"></div>
      </section>
    </div>
  </div>

<script>
(async function () {
  const $ = s => document.querySelector(s);
  const apiBase    = $('#apiBase');
  const publicBase = $('#publicBase');
  const threshold  = $('#threshold');
  const maxFaces   = $('#maxFaces');
  const prefix     = $('#prefix');
  const fileInput  = $('#file');
  const btnUpload  = $('#btnUpload');
  const btnSearch  = $('#btnSearch');
  const manualKey  = $('#manualKey');
  const results    = $('#results');
  const kpiStatus  = $('#kpiStatus');
  const kpiCount   = $('#kpiCount');
  const logEl      = $('#log');
  const pageInfo   = $('#pageInfo');
  const btnClear   = $('#btnClear');

  let matches = [];
  let page = 1, perPage = 12;

  btnClear.addEventListener('click', () => {
    matches = []; render();
    kpiCount.textContent = `0 matches`;
    log(`cleared`);
  });

  function log(msg, type='') {
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${msg}`;
    kpiStatus.textContent = type || 'ready';
  }

  function setBusy(b) {
    btnUpload.disabled = btnSearch.disabled = b;
    kpiStatus.textContent = b ? 'working...' : 'ready';
  }

  function buildImageURL(key){
    const base = publicBase.value.replace(/\/+$/,'');
    const k = String(key||'').replace(/^\/+/,'');
    return `${base}/${k}`;
  }

  function render(){
    // pagination
    const total = matches.length;
    const pages = Math.max(1, Math.ceil(total / perPage));
    page = Math.min(Math.max(1, page), pages);
    pageInfo.textContent = `Page ${page}/${pages}`;

    const start = (page-1)*perPage, end = start+perPage;
    const items = matches.slice(start, end);

    results.innerHTML = items.map(m => {
      const face  = m.Face || {};
      const sim   = (m.Similarity ?? m.similarity ?? 0).toFixed(1);
      const key   = face.ExternalImageId || face.ExternalImageID || m.externalImageId || '';
      const url   = key ? buildImageURL(key) : '';
      const conf  = (face.Confidence ?? m.confidence ?? 0).toFixed(1);
      return `
        <div class="tile">
          <img src="${url}" alt="">
          <div class="meta">
            <span class="muted">sim: <b>${sim}%</b></span>
            <span class="muted">conf: <b>${conf}%</b></span>
          </div>
          <div class="meta" title="${key}">
            <span class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${key || '-'}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  async function getUploadUrl(key){
    // POST /upload-url  -> {uploadUrl,key,bucket}
    const body = { key, contentType: 'image/jpeg', event: 'manual' };
    const r = await fetch(`${apiBase.value}/upload-url`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error(`upload-url ${r.status}`);
    return r.json();
  }

  async function putToS3(uploadUrl, file){
    // S3 presigned URL: send RAW bytes with ONLY Content-Type
    const r = await fetch(uploadUrl, {
      method:'PUT',
      headers:{ 'Content-Type':'image/jpeg' },
      body: file
    });
    if(!r.ok) throw new Error(`S3 PUT ${r.status}`);
  }

  async function callSearch(key){
    const body = {
      key,
      threshold: Number(threshold.value || 80),
      maxFaces: Number(maxFaces.value || 5),
    };
    const pfx = prefix.value.trim();
    if (pfx) body.prefix = pfx;

    const r = await fetch(`${apiBase.value}/search`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error(`search ${r.status}`);
    const js = await r.json();
    // normalize FaceMatches array
    const list = js.matches || js.FaceMatches || [];
    // unify field casing
    matches = list.map(x => {
      if (x.Face && !x.Face.ExternalImageId && x.Face.ExternalImageID)
        x.Face.ExternalImageId = x.Face.ExternalImageID;
      return x;
    });
    kpiCount.textContent = `${matches.length} matches`;
    render();
    return js;
  }

  btnUpload.addEventListener('click', async () => {
    const f = fileInput.files?.[0];
    if(!f){ log('Please choose a file', 'warn'); return; }
    try{
      setBusy(true);
      // destination key: optional prefix + ISO timestamp
      const pfx = prefix.value.trim();
      const stamp = new Date().toISOString().replace(/[:.]/g,'');
      const key = `${pfx ? pfx.replace(/\/?$/,'/') : ''}ui-${stamp}.jpg`;

      log(`Requesting presigned URL for ${key} ...`);
      const {uploadUrl} = await getUploadUrl(key);

      log('Uploading to S3 ...');
      await putToS3(uploadUrl, f);

      log('Uploaded. Running search ...');
      await callSearch(key);

      manualKey.value = key;
      log('Done', 'success');
    }catch(e){
      console.error(e);
      log(`Error: ${e.message}`, 'danger');
      alert(e.message);
    }finally{
      setBusy(false);
    }
  });

  btnSearch.addEventListener('click', async () => {
    const key = manualKey.value.trim();
    if(!key){ log('Enter a key to search', 'warn'); return; }
    try{
      setBusy(true);
      log(`Searching ${key} ...`);
      await callSearch(key);
      log('Done', 'success');
    }catch(e){
      console.error(e);
      log(`Error: ${e.message}`, 'danger');
      alert(e.message);
    }finally{
      setBusy(false);
    }
  });

  // init
  log('ready');
})();
</script>
</body>
</html>
